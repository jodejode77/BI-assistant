{
  "stats": {
    "total": 10,
    "worked": 9,
    "executed": 9,
    "similar_result": 0,
    "errors": 1,
    "total_time": 220.7521047592163,
    "avg_time_per_example": 22.07521047592163,
    "success_rate": {
      "worked": 90.0,
      "executed": 90.0,
      "similar_result": 0.0
    }
  },
  "results": [
    {
      "index": 1,
      "question": "Проанализируйте средний размер одобренного кредита по семейным статусам для сегмента клиентов с высшим образованием для оптимизации кредитных предложений.",
      "expected_sql": "SELECT at.NAME_FAMILY_STATUS, AVG(pa.AMT_CREDIT) FROM application_train at JOIN previous_application pa ON at.SK_ID_CURR = pa.SK_ID_CURR WHERE at.NAME_EDUCATION_TYPE = 'Higher education' AND pa.NAME_CONTRACT_STATUS = 'Approved' GROUP BY at.NAME_FAMILY_STATUS ORDER BY AVG(pa.AMT_CREDIT) DESC;",
      "worked": true,
      "executed": true,
      "similar_result": false,
      "generated_sql": "SELECT T1.name_family_status, AVG(CAST(T1.amt_credit AS numeric)) AS avg_loan_size FROM application_train AS T1 WHERE T1.target = 0 AND T1.name_education_type = 'Higher education' GROUP BY T1.name_family_status LIMIT 100",
      "error": null,
      "execution_time": 13.142409801483154,
      "rows_returned": 6,
      "comparison": {
        "similar": false,
        "rows_match": false,
        "columns_match": false,
        "values_similar": false,
        "expected_rows": 5,
        "generated_rows": 6,
        "similarity_score": 0.0
      }
    },
    {
      "index": 2,
      "question": "Сравнительный анализ среднего совокупного дохода для групп клиентов, обладающих автомобилем и не имеющих его.",
      "expected_sql": "SELECT FLAG_OWN_CAR, AVG(AMT_INCOME_TOTAL) FROM application_train GROUP BY FLAG_OWN_CAR;",
      "worked": true,
      "executed": true,
      "similar_result": false,
      "generated_sql": "SELECT flag_own_car, AVG(CAST(amt_income_total AS numeric)) AS avg_income FROM application_train GROUP BY flag_own_car LIMIT 100",
      "error": null,
      "execution_time": 13.04268503189087,
      "rows_returned": 2,
      "comparison": {
        "similar": false,
        "rows_match": true,
        "columns_match": false,
        "values_similar": false,
        "expected_rows": 2,
        "generated_rows": 2,
        "similarity_score": 0.0
      }
    },
    {
      "index": 3,
      "question": "По таблице POS_CASH_balance рассчитайте среднее значение показателя DPD_DEF по POS-кредитам (SK_DPD_DEF) для POS-кредитов с DPD > 0 в разрезе по клиенту (SK_ID_CURR) с агрегацией по POS-записям.",
      "expected_sql": "SELECT SK_ID_CURR AS group_key, AVG(SK_DPD_DEF) AS avg_sk_dpd_def FROM POS_CASH_balance WHERE SK_DPD > 0 GROUP BY SK_ID_CURR ORDER BY avg_sk_dpd_def DESC;",
      "worked": true,
      "executed": true,
      "similar_result": false,
      "generated_sql": "SELECT SK_ID_CURR, AVG(SK_DPD_DEF) AS avg_sk_dpd_def FROM POS_CASH_BALANCE WHERE SK_DPD > 0 GROUP BY SK_ID_CURR LIMIT 100",
      "error": null,
      "execution_time": 21.77390170097351,
      "rows_returned": 100,
      "comparison": {
        "similar": false,
        "rows_match": true,
        "columns_match": false,
        "values_similar": false,
        "expected_rows": 100,
        "generated_rows": 100,
        "similarity_score": 0.0
      }
    },
    {
      "index": 4,
      "question": "Постройте сложный SQL-запрос (WITH + JOIN) по previous_application и installments_payments, который для выборки для повторных клиентов (pa.NAME_CLIENT_TYPE = 'Repeater') сгруппирует данные по признаку просрочки платежа (delay_days > 0) и рассчитает средний по сегменту показатель средней задержки платежей на клиента (avg_delay_per_client).",
      "expected_sql": "WITH inst AS ( SELECT pa.SK_ID_CURR, pa.NAME_CONTRACT_TYPE, pa.NAME_CLIENT_TYPE, pa.CHANNEL_TYPE, pa.NAME_YIELD_GROUP, ip.NUM_INSTALMENT_NUMBER, ip.DAYS_INSTALMENT, ip.DAYS_ENTRY_PAYMENT, ip.AMT_INSTALMENT, ip.AMT_PAYMENT, (ip.DAYS_ENTRY_PAYMENT - ip.DAYS_INSTALMENT) AS delay_days, (ip.AMT_PAYMENT - ip.AMT_INSTALMENT) AS payment_diff, AVG(ip.DAYS_ENTRY_PAYMENT - ip.DAYS_INSTALMENT) OVER (PARTITION BY pa.SK_ID_CURR) AS avg_delay_per_client FROM previous_application pa JOIN installments_payments ip ON pa.SK_ID_PREV = ip.SK_ID_PREV WHERE pa.NAME_CLIENT_TYPE = 'Repeater' ) SELECT CASE WHEN delay_days > 0 THEN 'late' ELSE 'on_time' END AS group_key, AVG(avg_delay_per_client) AS metric_value FROM inst GROUP BY CASE WHEN delay_days > 0 THEN 'late' ELSE 'on_time' END ORDER BY metric_value DESC;",
      "worked": true,
      "executed": true,
      "similar_result": false,
      "generated_sql": "WITH delay_data AS ( SELECT pa.sk_id_curr, ip.days_entry_payment - ip.days_instalment AS delay_days FROM previous_application AS pa JOIN installments_payments AS ip ON pa.sk_id_prev = ip.sk_id_prev WHERE pa.NAME_CLIENT_TYPE = 'Repeater' ) SELECT CASE WHEN delay_days > 0 THEN 1 ELSE 0 END AS delinquency_indicator, AVG(delay_days) AS avg_delay_per_client FROM delay_data GROUP BY delinquency_indicator LIMIT 100",
      "error": null,
      "execution_time": 42.26643967628479,
      "rows_returned": 2,
      "comparison": {
        "similar": false,
        "rows_match": true,
        "columns_match": false,
        "values_similar": false,
        "expected_rows": 2,
        "generated_rows": 2,
        "similarity_score": 0.0
      }
    },
    {
      "index": 5,
      "question": "Когда к нам чаще всего обращаются за кредитами в течение дня?",
      "expected_sql": "SELECT HOUR_APPR_PROCESS_START, COUNT(SK_ID_CURR) FROM application_train GROUP BY HOUR_APPR_PROCESS_START ORDER BY COUNT(SK_ID_CURR) DESC;",
      "worked": true,
      "executed": true,
      "similar_result": false,
      "generated_sql": "SELECT hour_appr_process_start, COUNT(sk_id_prev) AS loan_count FROM previous_application GROUP BY hour_appr_process_start ORDER BY hour_appr_process_start LIMIT 100",
      "error": null,
      "execution_time": 14.008310317993164,
      "rows_returned": 24,
      "comparison": {
        "similar": false,
        "rows_match": true,
        "columns_match": false,
        "values_similar": false,
        "expected_rows": 24,
        "generated_rows": 24,
        "similarity_score": 0.0
      }
    },
    {
      "index": 6,
      "question": "Как в среднем изменяется первоначальный взнос по предыдущим кредитам для прошлых кредитов среднего размера (10 000–50 000) между клиентами между разными каналами продаж (отделение, интернет, партнер и т.д.)?",
      "expected_sql": "SELECT CHANNEL_TYPE AS group_key, AVG(AMT_DOWN_PAYMENT) AS avg_amt_down_payment FROM previous_application WHERE AMT_CREDIT BETWEEN 10000 AND 50000 GROUP BY CHANNEL_TYPE ORDER BY avg_amt_down_payment DESC;",
      "worked": true,
      "executed": true,
      "similar_result": false,
      "generated_sql": "SELECT AVG(CAST(T1.amt_down_payment AS numeric)) AS average_down_payment, T1.channel_type FROM previous_application AS T1 WHERE T1.amt_credit BETWEEN 10000 AND 50000 GROUP BY T1.channel_type LIMIT 100",
      "error": null,
      "execution_time": 15.804265022277832,
      "rows_returned": 7,
      "comparison": {
        "similar": false,
        "rows_match": true,
        "columns_match": false,
        "values_similar": false,
        "expected_rows": 7,
        "generated_rows": 7,
        "similarity_score": 0.0
      }
    },
    {
      "index": 7,
      "question": "Сделайте агрегированный срез по credit_card_balance: для карт без текущего остатка (AMT_BALANCE = 0), покажите средний объём текущих платежей по картам (AMT_PAYMENT_CURRENT) по каждому значению поля MONTHS_BALANCE.",
      "expected_sql": "SELECT MONTHS_BALANCE AS group_key, AVG(AMT_PAYMENT_CURRENT) AS avg_amt_payment_current FROM credit_card_balance WHERE AMT_BALANCE = 0 GROUP BY MONTHS_BALANCE ORDER BY avg_amt_payment_current DESC;",
      "worked": true,
      "executed": true,
      "similar_result": false,
      "generated_sql": "SELECT MONTHS_BALANCE, AVG(CAST(AMT_PAYMENT_CURRENT AS numeric)) AS avg_amt_payment_current FROM credit_card_balance WHERE AMT_BALANCE = 0 GROUP BY MONTHS_BALANCE LIMIT 100",
      "error": null,
      "execution_time": 21.455126762390137,
      "rows_returned": 96,
      "comparison": {
        "similar": false,
        "rows_match": true,
        "columns_match": false,
        "values_similar": false,
        "expected_rows": 96,
        "generated_rows": 96,
        "similarity_score": 0.0
      }
    },
    {
      "index": 8,
      "question": "В среднем, насколько сильно люди используют свои кредитные лимиты по картам?",
      "expected_sql": "SELECT AVG(AMT_BALANCE / AMT_CREDIT_LIMIT_ACTUAL) * 100 FROM credit_card_balance WHERE AMT_CREDIT_LIMIT_ACTUAL > 0",
      "worked": false,
      "executed": false,
      "similar_result": false,
      "generated_sql": null,
      "error": "(psycopg2.errors.DivisionByZero) division by zero\n\n[SQL: SELECT AVG(CAST(amt_balance AS numeric) / CAST(amt_credit_limit_actual AS numeric)) AS avg_utilization_rate FROM credit_card_balance LIMIT 100]\n(Background on this error at: https://sqlalche.me/e/20/9h9h)",
      "execution_time": 2.9677913188934326,
      "rows_returned": 0,
      "comparison": {}
    },
    {
      "index": 9,
      "question": "Какой день недели демонстрирует наибольшую/наименьшую частоту одобрения или отказа по кредитным заявкам?",
      "expected_sql": "SELECT WEEKDAY_APPR_PROCESS_START, SUM(CASE WHEN NAME_CONTRACT_STATUS = 'Approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN NAME_CONTRACT_STATUS = 'Refused' THEN 1 ELSE 0 END) AS refused_count FROM previous_application GROUP BY WEEKDAY_APPR_PROCESS_START ORDER BY approved_count DESC;",
      "worked": true,
      "executed": true,
      "similar_result": false,
      "generated_sql": "SELECT weekday_appr_process_start, SUM(CASE WHEN name_contract_status = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN name_contract_status = 'rejected' THEN 1 ELSE 0 END) AS rejected_count FROM previous_application GROUP BY weekday_appr_process_start ORDER BY approved_count DESC LIMIT 100",
      "error": null,
      "execution_time": 12.612413883209229,
      "rows_returned": 7,
      "comparison": {
        "similar": false,
        "rows_match": true,
        "columns_match": false,
        "values_similar": false,
        "expected_rows": 7,
        "generated_rows": 7,
        "similarity_score": 0.0
      }
    },
    {
      "index": 10,
      "question": "Какова разница в среднем уровне дохода (AMT_INCOME_TOTAL) между клиентами, склонными к дефолту, и теми, кто таковым не является?",
      "expected_sql": "SELECT TARGET, AVG(AMT_INCOME_TOTAL) FROM application_train_test GROUP BY TARGET;",
      "worked": true,
      "executed": true,
      "similar_result": false,
      "generated_sql": "SELECT CASE WHEN TARGET = 0 THEN 'Approved' WHEN TARGET = 1 THEN 'Defaulted' END AS default_status, AVG(CAST(AMT_INCOME_TOTAL AS numeric)) AS average_income FROM application_train GROUP BY TARGET LIMIT 100",
      "error": null,
      "execution_time": 12.873365640640259,
      "rows_returned": 2,
      "comparison": {
        "similar": false,
        "rows_match": false,
        "columns_match": false,
        "values_similar": false,
        "expected_rows": 0,
        "generated_rows": 2,
        "similarity_score": 0.0,
        "error": "(psycopg2.errors.UndefinedTable) relation \"application_train_test\" does not exist\nLINE 1: SELECT TARGET, AVG(AMT_INCOME_TOTAL) FROM application_train_...\n                                                  ^\n\n[SQL: SELECT TARGET, AVG(AMT_INCOME_TOTAL) FROM application_train_test GROUP BY TARGET LIMIT 100]\n(Background on this error at: https://sqlalche.me/e/20/f405)"
      }
    }
  ],
  "timestamp": "2025-11-19T23:24:32.801341",
  "benchmark_file": "/home/dark/Documents/GitHub/SQL_Agent_proj/tests/benchmark_3000.json"
}